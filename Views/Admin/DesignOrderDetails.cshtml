@model OneJevelsCompany.Web.Controllers.AdminController.DesignOrderDetailsVm
@{
    ViewData["Title"] = $"Order #{Model.Order.Id}";
}

<div class="max-w-6xl mx-auto space-y-6">

    <div class="flex items-center justify-between">
        <h2 class="text-2xl font-bold text-amber-700">Design Order #@Model.Order.Id</h2>
        <div class="flex items-center gap-2">
            <a class="px-4 py-2 rounded border" asp-controller="Admin" asp-action="DesignOrders">Back</a>
            <a class="px-4 py-2 rounded bg-gray-700 text-white"
               asp-controller="Admin" asp-action="DesignOrderProtocol" asp-route-id="@Model.Order.Id" target="_blank">
                Print protocol
            </a>
        </div>
    </div>

    @if (TempData["Err"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="rounded border border-red-300 bg-rose-50 text-red-800 px-3 py-2 whitespace-pre-line">@err</div>
    }
    @if (TempData["Ok"] is string ok && !string.IsNullOrWhiteSpace(ok))
    {
        <div class="rounded border border-green-300 bg-green-50 text-green-800 px-3 py-2">@ok</div>
    }

    <div class="grid md:grid-cols-3 gap-6">
        <!-- Left side: order + components -->
        <div class="md:col-span-2 bg-white p-4 rounded-2xl shadow">
            <div class="grid sm:grid-cols-2 gap-4">
                <div>
                    <div class="text-sm text-gray-500">Customer</div>
                    <div class="font-medium">@Model.Order.CustomerName</div>
                    <div class="text-xs text-gray-500">@Model.Order.CustomerEmail</div>
                    <div class="text-xs text-gray-500">@Model.Order.CustomerPhone</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Created</div>
                    <div>@Model.Order.CreatedUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Length / mm</div>
                    <div>@Model.Order.LengthCm.ToString("0.00") cm • @Model.Order.BeadMm mm</div>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Cycle / Capacity / Repeats</div>
                    <div>@Model.Order.OneCycleBeads / @Model.Order.CapacityEstimate / ×@Model.Repeats</div>
                </div>
            </div>

            <h3 class="mt-5 font-semibold">Components (per finished piece)</h3>
            <table class="min-w-full mt-2 bg-white rounded border">
                <thead class="bg-gray-50 text-left">
                    <tr>
                        <th class="px-3 py-2">#</th>
                        <th class="px-3 py-2">Component</th>
                        <th class="px-3 py-2">mm</th>
                        <th class="px-3 py-2">Per piece</th>
                        <th class="px-3 py-2">Stock</th>
                        <th class="px-3 py-2">Cost</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Rows.Count; i++)
                    {
                        var r = Model.Rows[i];
                        <tr class="border-t">
                            <td class="px-3 py-2">@(@i + 1)</td>
                            <td class="px-3 py-2">
                                <div class="flex items-center gap-2">
                                    @if (!string.IsNullOrWhiteSpace(r.ImageUrl))
                                    {
                                        <img src="@r.ImageUrl" style="width:36px;height:36px;border-radius:9999px;object-fit:cover;border:1px solid #eee" />
                                    }
                                    <div>
                                        <div class="font-medium">@r.Name</div>
                                        <div class="text-xs text-gray-500">ID: @r.ComponentId</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 py-2">@r.Mm</td>
                            <td class="px-3 py-2">@r.CountPerJewel</td>
                            <td class="px-3 py-2">@r.Stock</td>
                            <td class="px-3 py-2">@r.CostPerJewel.ToString("C")</td>
                        </tr>
                    }
                    <tr class="border-t bg-gray-50 font-medium">
                        <td class="px-3 py-2" colspan="5">Materials cost / piece</td>
                        <td class="px-3 py-2">@Model.MaterialsCostPerJewel.ToString("C")</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Right side: create jewel -->
        <div class="bg-white p-4 rounded-2xl shadow">
            <h3 class="font-semibold">Create ready Jewel</h3>
            <form asp-controller="Admin" asp-action="BuildDesignOrder" asp-route-id="@Model.Order.Id" method="post">
                @Html.AntiForgeryToken()
                <div class="mt-2">
                    <label class="block text-sm text-gray-600 mb-1">Name (for catalog)</label>
                    <input name="newJewelName" class="w-full border rounded p-2" value="Custom design #@Model.Order.Id" />
                </div>
                <div class="mt-2">
                    <label class="block text-sm text-gray-600 mb-1">Unit price (manual)</label>
                    <input name="newJewelPrice" type="number" step="0.01" class="w-full border rounded p-2"
                           value="@Model.MaterialsCostPerJewel.ToString("0.00")" />
                    <div class="text-xs text-gray-500">You can set any selling price; materials cost shown above.</div>
                </div>
                <div class="mt-2">
                    <label class="block text-sm text-gray-600 mb-1">Quantity to build</label>
                    <input name="qty" type="number" min="1" class="w-full border rounded p-2" value="@Model.Order.Quantity" />
                </div>

                <button class="mt-4 w-full px-4 py-2 rounded bg-amber-600 text-white hover:bg-amber-500" type="submit">
                    Create jewel & reserve components
                </button>
            </form>

            <div class="mt-3 text-xs text-gray-500">
                This will add a Jewel entry with all components and subtract total quantities from stock.
                Order status will change to <b>Built</b>.
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
          const qtyInput = document.querySelector('input[name="qty"]');
          const submitBtn = document.querySelector('button[type="submit"]');

          if (!qtyInput || !submitBtn) return;

          // Build a list of {name, perPiece, stock} from the table
          const rows = [...document.querySelectorAll('table tbody tr.border-t')].map(tr => {
            const name = tr.querySelector('.font-medium')?.textContent?.trim() || 'Component';
            const perPiece = parseInt(tr.querySelector('td:nth-child(4)')?.textContent?.trim() || '0', 10); // "Per piece" col
            const stock = parseInt(tr.querySelector('td:nth-child(5)')?.textContent?.trim() || '0', 10);    // "Stock" col
            return { tr, name, perPiece, stock };
          }).filter(r => r.perPiece > 0);

          const warn = document.createElement('div');
          warn.style.marginTop = '8px';
          warn.style.display = 'none';
          warn.className = 'rounded border border-rose-300 bg-rose-50 text-rose-800 px-3 py-2 text-sm';
          submitBtn.parentElement.appendChild(warn);

          function check() {
            const q = Math.max(1, parseInt(qtyInput.value || '1', 10));
            const shortages = [];

            rows.forEach(r => {
              const need = r.perPiece * q;
              const ok = r.stock >= need;
              r.tr.style.backgroundColor = ok ? '' : 'rgba(254,226,226,.6)'; // light red if shortage
              if (!ok) shortages.push(`${r.name}: need ${need}, have ${r.stock}`);
            });

            if (shortages.length) {
              warn.textContent = 'Not enough stock: ' + shortages.join(' • ');
              warn.style.display = '';
              submitBtn.disabled = false; // set to true if you want to disable the button
            } else {
              warn.style.display = 'none';
              submitBtn.disabled = false;
            }
          }

          qtyInput.addEventListener('input', check);
          check(); // initial
        })();
    </script>
}
